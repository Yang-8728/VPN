# Outline VPN 快速部署指南

## 第一步：购买华为云服务器

### 1.1 登录华为云

访问 https://www.huaweicloud.com/ 并登录（如果没有账号需要先注册）

### 1.2 进入购买页面

1. 在控制台首页，点击左上角 **产品** → **计算** → **弹性云服务器 ECS**
2. 或者直接搜索 "ECS" 进入

### 1.3 选择配置

**区域选择：**
- 选择 **中国大陆区域**（北京、上海、广州任选一个）
- 注意：必须选中国区域，不要选香港或海外

**基础配置：**
- **计费模式**：按需计费（用多久付多久，用完删除立即停止计费）
- **规格**：通用计算型 s6.small.1 或最小的 1核1GB 配置
- **镜像**：公共镜像 → Ubuntu → Ubuntu 20.04 或 22.04 server 64bit
- **系统盘**：高IO 20GB（默认即可）

**网络配置：**
- **虚拟私有云**：使用默认 VPC 或新建一个
- **安全组**：新建安全组或选择已有的
- **弹性公网IP**：选择 **现在购买**
- **带宽**：按流量计费，1Mbps 即可

**登录方式：**
- 选择 **密码** 方式
- 设置 root 密码（记住这个密码，后面 SSH 登录要用）

### 1.4 配置安全组（重要！）

安全组控制服务器的端口访问，必须正确配置才能连接 VPN。

**方式一：允许所有端口（最简单）**
- 入方向规则：
  - 协议：全部
  - 端口：全部
  - 源地址：0.0.0.0/0
  
**方式二：只开放必要端口（更安全）**
- 入方向规则：
  - SSH：TCP 22（用于登录服务器）
  - Outline 管理：TCP 随机端口（脚本会自动分配，建议开放 1024-65535）
  - Outline 连接：TCP + UDP 随机端口（建议开放 1024-65535）

**推荐：** 如果是临时使用，直接选方式一最省事。

### 1.5 确认购买

- 检查配置摘要
- 勾选同意服务协议
- 点击 **立即购买**
- 等待服务器创建完成（通常 1-2 分钟）

### 1.6 获取服务器 IP

- 在 ECS 控制台找到刚创建的服务器
- 记下 **弹性公网IP**（例如：123.45.67.89）
- 这个 IP 后面要用

## 第二步：连接服务器

```bash
# 使用 SSH 连接到服务器
ssh root@你的服务器IP
```

## 第三步：运行部署脚本

```bash
# 下载脚本（如果你把脚本上传到服务器）
# 或者直接复制 deploy-outline.sh 的内容到服务器

# 给脚本执行权限
chmod +x deploy-outline.sh

# 运行脚本
sudo bash deploy-outline.sh
```

## 第四步：保存连接信息

脚本运行完成后，会显示类似这样的信息：

```
CONGRATULATIONS! Your Outline server is up and running.

To manage your Outline server, please copy the following line (including curly brackets) into Step 2 of the Outline Manager interface:

{"apiUrl":"https://xxx.xxx.xxx.xxx:xxxxx/xxxxxx","certSha256":"xxxxxx"}
```

**重要：保存这段信息！**

同时还会显示一个 `ss://` 开头的连接字符串，这个是给客户端用的。

## 第五步：iPhone 连接

### 5.1 下载 Outline 客户端

1. 在 iPhone 上打开 **App Store**
2. 搜索 **"Outline"**
3. 找到 **"Outline - Secure internet access"**（开发者：Jigsaw）
4. 点击 **获取** 下载（完全免费，无需付费）
5. 等待下载安装完成

**注意：** 
- Outline 是完全免费的开源应用
- 不要下载错了其他同名应用
- 开发者应该是 "Jigsaw"

### 5.2 添加服务器

1. 打开 Outline App
2. 点击屏幕上的 **"+"** 按钮（或 "添加服务器"）
3. 选择 **"手动输入访问密钥"**
4. 粘贴之前保存的 `ss://` 开头的访问密钥
5. 点击 **"添加"** 或 **"连接"**

**提示：**
- 访问密钥就是部署脚本输出的那个 ss:// 开头的长字符串
- 可以给服务器起个名字，比如 "中国VPN"
- 如果有二维码，也可以扫码添加

### 5.3 连接使用

1. 在服务器列表中，点击刚添加的服务器
2. 等待连接（通常 3-5 秒）
3. 连接成功后，状态会变成 **"已连接"**（绿色）
4. 此时你的所有网络流量都会通过中国服务器

**连接状态说明：**
- 🔴 **未连接**：流量不经过 VPN，正常泰国网络
- 🟡 **连接中**：正在建立连接，请稍候
- 🟢 **已连接**：所有流量通过中国服务器

**断开连接：**
- 再次点击服务器即可断开
- 或者在 Outline 主界面点击 "断开连接"

## 第六步：验证连接

### 6.1 检查 IP 地址

1. 确保 Outline 已连接（状态显示 🟢 已连接）
2. 在 iPhone 上打开 Safari 浏览器
3. 访问 https://ip.sb 或 https://ip.cn
4. 页面应该显示 **中国的 IP 地址**
5. 如果显示泰国 IP，说明连接有问题

**正常显示示例：**
```
您的 IP: 123.45.67.89
位置: 中国 北京/上海/广州
```

### 6.2 测试接收验证码

1. 确认 IP 显示为中国后
2. 打开你需要的中国 App（如微信、支付宝、淘宝等）
3. 进行需要验证码的操作（登录、注册、验证等）
4. 应该能正常接收到短信验证码

**如果收不到验证码：**
- 检查 Outline 是否真的连接成功
- 重新检查 IP 地址是否显示中国
- 尝试断开重连
- 查看下面的故障排查部分

## 第七步：用完删除服务器

**⚠️ 重要：接收完验证码后，立即删除服务器，避免持续扣费！**

### 7.1 断开 VPN 连接

1. 在 iPhone 的 Outline App 中
2. 点击服务器断开连接
3. 确认状态变为 🔴 未连接

### 7.2 删除华为云服务器

1. 在电脑上登录华为云控制台 https://console.huaweicloud.com/
2. 进入 **弹性云服务器 ECS** 控制台
3. 找到刚才创建的服务器
4. 点击 **更多** → **删除**
5. 确认删除（勾选同时删除弹性公网IP和数据盘）
6. 点击 **是，删除**

### 7.3 确认计费停止

1. 删除服务器后，计费立即停止
2. 可以在 **费用中心** → **消费明细** 查看总费用
3. 通常使用 1 小时总费用不超过 0.5 元

### 7.4 清理 Outline 客户端（可选）

如果以后不再使用，可以：
1. 在 Outline App 中删除服务器配置
2. 或者直接卸载 Outline App

**下次需要使用时：**
- 重新购买服务器
- 重新运行部署脚本
- 获取新的访问密钥
- 在 Outline 中添加新服务器

## 故障排查

### 问题 1：无法 SSH 连接服务器

**可能原因：**
- 服务器 IP 地址错误
- 安全组没有开放 22 端口
- 密码输入错误

**解决方法：**
1. 在华为云控制台确认服务器的公网 IP
2. 检查安全组规则，确保开放了 TCP 22 端口
3. 确认使用正确的密码（购买时设置的 root 密码）
4. 尝试使用华为云的 **远程登录（VNC）** 功能

### 问题 2：部署脚本运行失败

**可能原因：**
- 没有使用 root 权限
- 网络连接问题
- Docker 安装失败

**解决方法：**
1. 确保使用 `sudo bash deploy-outline.sh` 运行
2. 检查服务器网络连接：`ping baidu.com`
3. 如果 Docker 安装失败，手动安装：
   ```bash
   curl -fsSL https://get.docker.com -o get-docker.sh
   sudo sh get-docker.sh
   ```
4. 查看错误信息，根据提示解决

### 问题 3：Outline 无法连接服务器

**可能原因：**
- 安全组端口未开放
- 访问密钥错误
- 服务器防火墙阻止

**解决方法：**
1. **检查安全组**（最常见原因）：
   - 登录华为云控制台
   - 进入 ECS → 安全组
   - 确保开放了所有 TCP 和 UDP 端口（或至少 1024-65535）
   
2. **检查访问密钥**：
   - 确认复制的是完整的 ss:// 字符串
   - 重新复制粘贴一次
   
3. **检查 Outline 服务状态**：
   ```bash
   # SSH 登录服务器后执行
   docker ps
   ```
   应该看到一个 outline/shadowbox 容器在运行
   
4. **检查防火墙**：
   ```bash
   # 如果启用了 ufw，需要开放端口
   sudo ufw status
   # 如果是 active，执行：
   sudo ufw disable
   ```

### 问题 4：连接成功但无法访问网站

**可能原因：**
- Outline 服务异常
- 网络路由问题

**解决方法：**
1. 断开重连 Outline
2. 检查 Outline 服务日志：
   ```bash
   docker logs $(docker ps -q --filter ancestor=quay.io/outline/shadowbox)
   ```
3. 重启 Outline 容器：
   ```bash
   docker restart $(docker ps -q --filter ancestor=quay.io/outline/shadowbox)
   ```

### 问题 5：验证码收不到

**可能原因：**
- VPN 实际未连接
- IP 地址未显示为中国
- App 本身的问题

**解决方法：**
1. **确认 VPN 已连接**：
   - Outline 状态显示 🟢 已连接
   - 访问 https://ip.sb 确认显示中国 IP
   
2. **如果 IP 不是中国**：
   - 断开重连
   - 删除服务器重新添加
   - 检查是否选择了中国区域的服务器
   
3. **如果 IP 正确但还是收不到**：
   - 检查手机网络权限
   - 尝试关闭其他 VPN 或代理
   - 重启 App
   - 可能是 App 本身的限制，尝试其他 App

### 问题 6：费用比预期高

**可能原因：**
- 忘记删除服务器
- 流量费用

**解决方法：**
1. 立即登录华为云控制台删除服务器
2. 检查是否有其他未删除的资源（如弹性 IP、数据盘）
3. 在费用中心查看详细账单
4. 下次使用完立即删除

## 成本估算

- 服务器：1核1G，按需计费，约 0.1-0.2 元/小时
- 使用 1 小时：约 0.1-0.2 元
- Outline 客户端：完全免费

总成本：几毛钱

**重要提醒：用完立即删除服务器！**
- 按需计费是按小时扣费的
- 即使不用也会一直扣费
- 接收完验证码后，立即在华为云控制台删除服务器
- 删除后计费立即停止

**如何查看费用：**
- 登录华为云控制台
- 点击右上角 **费用中心**
- 查看 **消费明细**
